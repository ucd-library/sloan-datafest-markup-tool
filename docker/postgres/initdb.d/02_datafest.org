** Datafest
#+PROPERTY: header-args:sql :engine postgresql :cmdline "service=datafest201912" :tangle yes

The datafest schema holds the tables that are used in the crowd source program.

*** Roles

Are in the database initialization steps

*** Tables

The datafest tables include all the information for the web-application, and
holds the crowd-source marks as well.

#+BEGIN_SRC sql
DROP SCHEMA IF exists datafest cascade;
create schema datafest;
#+END_SRC

#+RESULTS:
| DROP SCHEMA   |
|---------------|
| CREATE SCHEMA |

#+BEGIN_SRC sql
SET search_path = datafest,public,pg_catalog;

-- CREATE TABLES
CREATE TABLE catalog (
  catalog_id TEXT PRIMARY KEY,
  name TEXT NOT NULL
);

CREATE TABLE page (
  page_id TEXT PRIMARY KEY,
  catalog_id TEXT  REFERENCES catalog NOT NULL,
  index INTEGER NOT NULL,
  score INTEGER
);

CREATE TABLE mark (
  mark_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  page_id TEXT REFERENCES page NOT NULL,
  user_id TEXT NOT NULL,
  type TEXT,
  implicator_top INTEGER,
  implicator_left INTEGER,
  implicator_bottom INTEGER,
  implicator_right INTEGER,
  region_top INTEGER,
  region_left INTEGER,
  region_bottom INTEGER,
  region_right INTEGER,
  section_title TEXT,
  wine_type TEXT,
  bottle_type TEXT,
  color TEXT,
  vintage INTEGER,
  country TEXT,
  bottle_price FLOAT,
  case_price FLOAT
);
#+END_SRC

#+RESULTS:
| SET          |
|--------------|
| CREATE TABLE |
| CREATE TABLE |
| CREATE TABLE |

Catalog and Page initialization for datafest happens at the initialization step
by interogating the


*** Authentication

#+BEGIN_SRC sql
-- ALLOW PGR TO UPGRADE ROLES
GRANT datafestuser TO authenticator;
GRANT anon TO authenticator;
GRANT admin TO authenticator;

-- SET ROLE USAGE
GRANT usage ON SCHEMA datafest TO public;
GRANT SELECT ON ALL TABLES IN SCHEMA datafest TO public;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA datafest TO public;

GRANT INSERT ON datafest.mark TO datafestuser;
GRANT UPDATE ON datafest.mark TO datafestuser;
GRANT DELETE ON datafest.mark TO datafestuser;

GRANT usage ON SCHEMA datafest TO admin;
grant all on all tables in schema datafest to admin;
grant execute on all functions in schema datafest to admin;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA datafest TO admin;

#+END_SRC

#+RESULTS:
| GRANT ROLE |
|------------|
| GRANT ROLE |
| GRANT ROLE |
| GRANT      |
| GRANT      |
| GRANT      |
| GRANT      |
| GRANT      |
| GRANT      |
| GRANT      |
| GRANT      |
| GRANT      |
| GRANT      |
